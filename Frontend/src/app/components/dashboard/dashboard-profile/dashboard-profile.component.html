<!-- HEADER del dashboard -->
<app-header-dashboard></app-header-dashboard>

<div class="profile-wrapper">
  <!-- HERO -->
  <section class="profile-hero">
    <div class="profile-identity">
      <div class="avatar">
        <span>{{ (firstName || 'A')[0] }}{{ (lastName || 'N')[0] }}</span>
      </div>
      <div class="identity-texts">
        <h1 class="display-name">{{ firstName }} {{ lastName }}</h1>
        <div class="email">{{ email }}</div>
        <span class="role-pill">{{ role }}</span>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-number">3</div>
        <div class="stat-label">Proyectos</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">8</div>
        <div class="stat-label">Colaboraciones</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">126</div>
        <div class="stat-label">D√≠as activo</div>
      </div>
    </div>
  </section>

  <!-- TABS -->
  <div class="tabs-row">
    <button class="tab" [class.active]="activeTab === 'info'" (click)="setTab('info')">
      Informaci√≥n
    </button>
    <button class="tab" [class.active]="activeTab === 'security'" (click)="setTab('security')">
      Seguridad
    </button>

    <!-- Si es admin, mostramos Instituciones y Usuarios -->
    <ng-container *ngIf="role === 'admin'; else userTabs">
      <button class="tab" [class.active]="activeTab === 'institutions'" (click)="setTab('institutions')">
        Instituciones
      </button>
      <button class="tab" [class.active]="activeTab === 'users'" (click)="setTab('users')">
        Usuarios
      </button>
    </ng-container>

    <!-- Si NO es admin, mostramos Actividad y Notificaciones -->
    <ng-template #userTabs>
      <button class="tab" [class.active]="activeTab === 'activity'" (click)="setTab('activity')">
        Actividad
      </button>
      <button class="tab" [class.active]="activeTab === 'notifications'" (click)="setTab('notifications')">
        Notificaciones
      </button>
    </ng-template>
  </div>

  <!-- Informaci√≥n -->
  <div class="profile-section-card" *ngIf="activeTab === 'info'">
    <div class="profile-section-card" *ngIf="activeTab === 'info'">
      <div class="section-header">
        <h3 class="section-title">Informaci√≥n del perfil</h3>

        <button class="btn-edit" type="button" (click)="toggleEdit()">
          {{ isEditing ? 'Dejar de editar' : 'Editar perfil' }}
        </button>
      </div>

      <form (ngSubmit)="saveProfile()">
        <div class="grid-2">
          <div class="form-field">
            <label>Nombre</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="firstName"
              name="firstName"
              [disabled]="!isEditing"
            />
          </div>

          <div class="form-field">
            <label>Apellido</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="lastName"
              name="lastName"
              [disabled]="!isEditing"
            />
          </div>

          <div class="form-field">
            <label>Correo</label>
            <input
              type="email"
              class="form-control"
              [(ngModel)]="email"
              name="email"
              [disabled]="!isEditing"
            />
          </div>

          <div class="form-field">
            <label>Tel√©fono</label>
            <input
              type="tel"
              class="form-control"
              [(ngModel)]="phone"
              name="phone"
              [disabled]="!isEditing"
            />
          </div>

          <div class="form-field">
            <label>Instituci√≥n</label>
            <select
              class="form-control"
              [(ngModel)]="selectedInstitution"
              name="institution"
              [disabled]="!isEditing"
            >
              <option *ngFor="let inst of institutions" [value]="inst.id">
                {{ inst.name }}
              </option>
            </select>
          </div>


          <div class="form-field form-field--full">
            <label>Biograf√≠a</label>
            <textarea
              class="form-control"
              rows="5"
              [(ngModel)]="bio"
              name="bio"
              placeholder="Cu√©ntanos sobre tus l√≠neas de investigaci√≥n‚Ä¶"
              [disabled]="!isEditing"
            ></textarea>
          </div>
        </div>

        <div class="form-actions" *ngIf="isEditing">
          <button type="button" class="btn-secondary" (click)="cancelEdit()">
            Cancelar
          </button>
          <button type="submit" class="btn-primary">
            Guardar cambios
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Seguridad -->
  <div class="profile-section-card" *ngIf="activeTab === 'security'">
    <div class="profile-section-card" *ngIf="activeTab === 'security'">
      <div class="section-header">
        <h3 class="section-title">Seguridad</h3>
      </div>

      <form (ngSubmit)="changePassword()">
        <div class="grid-2">
          <div class="form-field form-field--full">
            <label>Contrase√±a actual</label>
            <input
              type="password"
              class="form-control"
              [(ngModel)]="oldPassword"
              name="oldPassword"
              autocomplete="current-password"
            />
          </div>

          <div class="form-field">
            <label>Nueva contrase√±a</label>
            <input
              type="password"
              class="form-control"
              [(ngModel)]="newPassword"
              name="newPassword"
              autocomplete="new-password"
            />
          </div>

          <div class="form-field">
            <label>Confirmar nueva contrase√±a</label>
            <input
              type="password"
              class="form-control"
              [(ngModel)]="confirmPassword"
              name="confirmPassword"
              autocomplete="new-password"
            />
          </div>
        </div>

        <div class="feedback" *ngIf="successMsg || errorMsg">
          <div class="alert success" *ngIf="successMsg">{{ successMsg }}</div>
          <div class="alert error" *ngIf="errorMsg">{{ errorMsg }}</div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary" [disabled]="isSubmitting">
            {{ isSubmitting ? 'Guardando‚Ä¶' : 'Actualizar contrase√±a' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Instituciones -->
  <div class="profile-section-card" *ngIf="activeTab === 'institutions'">
    <div class="section-header">
      <h3 class="section-title">Gesti√≥n de Instituciones</h3>
    </div>

    <!-- Barra de b√∫squeda -->
    <div class="form-field form-field--full" style="margin-bottom: 15px;">
      <input
        type="text"
        class="form-control"
        placeholder="Buscar instituci√≥n..."
        [(ngModel)]="institutionSearch"
        (input)="filterInstitutions()"
      />
    </div>

  <!-- Listado de instituciones -->
  <table class="institutions-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let inst of getPagedInstitutions()">
        <td>{{ inst.id }}</td>
        <td>{{ inst.name }}</td>
        <td>
        <a class="btn-icon" [routerLink]="['/dashboard-profile/institution', inst.id]">
          üîç
        </a>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Controles de paginaci√≥n -->
  <div class="pagination-controls">
    <button class="btn-secondary" (click)="prevPage()" [disabled]="page === 1">‚¨Ö Anterior</button>
    <span>P√°gina {{ page }} de {{ totalPages }}</span>
    <button class="btn-primary" (click)="nextPage()" [disabled]="page === totalPages">Siguiente ‚û°</button>
  </div>
  </div>

  <!-- Usuarios -->
  <div class="profile-section-card" *ngIf="activeTab === 'users' && role === 'admin'">
    <div class="section-header">
      <h3 class="section-title">Gesti√≥n de Usuarios</h3>
    </div>
    <p class="placeholder">Aqu√≠ administraremos los usuarios: asignar roles, editar y gestionar cuentas.</p>
  </div>

  <!-- PLACEHOLDERS -->
  <div class="profile-section-card" *ngIf="activeTab === 'activity' && role !== 'admin'">
    <div class="section-header">
      <h3 class="section-title">Actividad</h3>
    </div>
    <p class="placeholder">Aqu√≠ podr√°s ver y filtrar la actividad reciente de tu cuenta.</p>
  </div>

  <div class="profile-section-card" *ngIf="activeTab === 'notifications' && role !== 'admin'">
    <div class="section-header">
      <h3 class="section-title">Notificaciones</h3>
    </div>
    <p class="placeholder">Configura tus preferencias de notificaci√≥n aqu√≠.</p>
  </div>
</div>

<!-- FOOTER -->
<app-footer></app-footer>
